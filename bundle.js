(()=>{"use strict";window.util={debounce:e=>{let t=null;return function(...o){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...o)}),500)}}},(()=>{const e="https://21.javascript.pages.academy/keksobooking/data",t="https://21.javascript.pages.academy/keksobooking",o=(e,t,o,n)=>{const r=new XMLHttpRequest;return r.responseType="json",r.addEventListener("load",(()=>{200===r.status?o(r.response):n(`Статус ответа: ${r.status} - ${r.statusText}`)})),r.addEventListener("error",(function(){n("Произошла ошибка соединения")})),r.addEventListener("timeout",(function(){n(`Запрос не успел выполниться за ${r.timeout} мс`)})),r.timeout=1e4,r.open(e,t),r};window.backend={load:(t,n)=>o("GET",e,t,n).send(),upload:(e,n,r)=>o("POST",t,n,r).send(e)}})(),(()=>{const e="Дворец",t="Квартира",o="Дом",n="Бунгало",r=document.querySelector("#card").content.querySelector(".popup").cloneNode(!0);window.card={renderPopup:a=>{const{author:{avatar:i},offer:{title:s,address:l,price:c,rooms:d,guests:u,checkin:p,checkout:m,description:v}}=a;return r.querySelector(".popup__title").textContent=s,r.querySelector(".popup__text--address").textContent=l,(a=>{const i=r.querySelector(".popup__type");"palace"===a.offer.type?i.textContent=e:"flat"===a.offer.type?i.textContent=t:"house"===a.offer.type?i.textContent=o:i.textContent=n})(a),r.querySelector(".popup__text--price").textContent=c+" ₽/ночь",r.querySelector(".popup__text--capacity").textContent=`${d} комнаты для ${u} гостей`,r.querySelector(".popup__text--time").textContent=`Заезд после ${p}, выезд до ${m}`,(e=>{const t=r.querySelector(".popup__features");t.textContent="";for(let o=0;o<e.offer.features.length;o++){const n=document.createElement("li");n.className="popup__feature",t.appendChild(n),n.classList.add("popup__feature--"+e.offer.features[o])}})(a),r.querySelector(".popup__description").textContent=v,(e=>{const t=r.querySelector(".popup__photos");t.textContent="";for(let o=0;o<e.offer.photos.length;o++){const n=document.createElement("img");n.src=e.offer.photos[o],n.alt="Фотография жилья",n.className="popup__photo",n.width=45,n.height=40,t.appendChild(n)}})(a),r.querySelector(".popup__avatar").src=i,r}}})(),(()=>{const e={LOW:{MIN:0,MAX:1e4},MIDDLE:{MIN:1e4,MAX:5e4},HIGH:{MIN:5e4,MAX:1/0}},t="any",o="type",n="rooms",r="guests",a=document.querySelector(".map__filters"),i=a.querySelectorAll("select"),s=a.querySelectorAll("input"),l=a.querySelector("#housing-type"),c=a.querySelector("#housing-price"),d=a.querySelector("#housing-rooms"),u=a.querySelector("#housing-guests"),p=a.querySelector("#housing-features");let m=[];const v=(e,o,n)=>e.value===t||e.value===o[n].toString(),y=t=>{const o=e[c.value.toUpperCase()];return!o||t.offer.price>=o.MIN&&t.offer.price<=o.MAX},f=e=>v(d,e.offer,n),w=e=>v(u,e.offer,r),h=e=>{const t=p.querySelectorAll("input:checked");return Array.from(t).every((t=>e.offer.features.includes(t.value)))},_=window.util.debounce((()=>{let e=[],t=!0;for(let r=0;r<m.length&&(n=m[r],t=v(l,n.offer,o),!(!1!==t&&(t=y(m[r]),!1!==t&&(t=f(m[r]),!1!==t&&(t=w(m[r]),!1!==t&&(t=h(m[r]),!1!==t&&(e.push(m[r]),e.length>=5)))))));r++);var n;window.map.cardRemoveHandler(),window.map.pinsRemoveHandler(),window.map.renderPinsMarkup(e)})),S=e=>{i.forEach((t=>{t.disabled=e})),s.forEach((t=>{t.disabled=e}))};window.filter={setFiltersActive:()=>{S(!1),a.addEventListener("change",_)},activateFiltration:e=>(m=e.slice(0),window.filter.setFiltersActive(),e.slice(0,5)),setFiltersDisactive:()=>{S(!0),i.forEach((e=>{e.value=t})),s.forEach((e=>{e.checked=!1})),a.removeEventListener("change",_)}}})(),(()=>{const e=document.querySelector("#pin").content.querySelector(".map__pin");window.pin={renderOffers:t=>{const o=e.cloneNode(!0),{location:{x:n,y:r},author:{avatar:a},offer:{description:i,id:s}}=t;return o.style.left=n-25+"px",o.style.top=r-70+"px",o.querySelector("img").src=a,o.querySelector("img").alt=i,o.dataset.id=s,o}}})(),(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),o=e.querySelector(".map__pin--main"),n=document.querySelector(".ad-form"),r=n.querySelectorAll("fieldset"),a=n.querySelector('input[name="address"]');a.setAttribute("readonly",!0),o.addEventListener("mousedown",(t=>{t.preventDefault();let n={x:t.clientX,y:t.clientY};const r=t=>{t.preventDefault();const r=n.x-t.clientX,i=n.y-t.clientY;n={x:t.clientX,y:t.clientY},o.style.top=o.offsetTop-i+"px",o.style.left=o.offsetLeft-r+"px";const s=o.offsetTop-i,l=o.offsetLeft-r;l>e.clientWidth-32.5&&(o.style.left=e.clientWidth-32.5+"px"),l<-32.5&&(o.style.left="-32.5px"),s<43&&(o.style.top=Math.round(43)+"px"),s>543&&(o.style.top=Math.round(543)+"px"),a.value=o.offsetLeft+Math.round(32.5)+", "+(o.offsetTop+65+22)},i=e=>{e.preventDefault(),document.removeEventListener("mousemove",r),document.removeEventListener("mouseup",i)};document.addEventListener("mousemove",r),document.addEventListener("mouseup",i)}));const i=e=>{window.offers=e.map(((e,t)=>(e.offer.id=t,e))),window.map.renderPinsMarkup(window.filter.activateFiltration(window.offers))},s=e=>{const t=document.createElement("div");t.style.zIndex=100,t.style.margin="0 auto",t.style.textAlign="center",t.style.backgroundColor="red",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.fontSize="30px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)},l=()=>{c()},c=()=>{e.classList.remove("map--faded"),n.classList.remove("ad-form--disabled"),r.forEach((e=>{e.disabled=!1})),window.filter.setFiltersActive(),window.backend.load(i,s),o.removeEventListener("click",l),e.addEventListener("click",m),a.value=570+Math.round(32.5)+", 462"},d=()=>{e.querySelector(".map__card").remove();const t=e.querySelector(".map__pin--active");t&&t.classList.remove("map__pin--active"),document.removeEventListener("keydown",u)},u=e=>{"Escape"===e.key&&d()},p=(o,n)=>{e.insertBefore(window.card.renderPopup(window.offers[o]),t),n.classList.add("map__pin--active"),document.addEventListener("keydown",u),e.querySelector(".popup__close").addEventListener("click",d)},m=t=>{const o=t.target.closest(".map__pin"),n=e.querySelector(".map__card");if(o&&!o.classList.contains("map__pin--main")){const e=o.attributes[3].value;n?(d(),p(e,o)):p(e,o)}};window.map={setDefaultPinPosition:()=>{o.style.left="570px",o.style.top="375px"},renderPinsMarkup:e=>{const o=document.createDocumentFragment();e.forEach((e=>{o.appendChild(window.pin.renderOffers(e))})),t.appendChild(o)},pinsRemoveHandler:()=>{document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((e=>{e.remove()}))},cardRemoveHandler:()=>{document.querySelector(".map__card")&&d()},setDisactiveState:()=>{e.classList.add("map--faded"),n.classList.add("ad-form--disabled"),r.forEach((e=>{e.disabled=!0})),window.filter.setFiltersDisactive(),o.addEventListener("click",l),window.map.cardRemoveHandler(),window.map.pinsRemoveHandler(),a.value=570+Math.round(32.5)+", "+(375+Math.round(32.5))}}})(),(()=>{const e={palace:"дворец",flat:"квартира",house:"дом",bungalow:"бунгало"},t={palace:1e4,flat:1e3,house:5e3,bungalow:0},o=[1,2,3,100],n=[3,2,1,0],r=1e6,a="Escape",i=document.querySelector("main"),s=document.querySelector(".ad-form"),l=s.querySelector('select[name="rooms"]'),c=s.querySelector('select[name="capacity"]'),d=s.querySelector("#title"),u=s.querySelector("#price"),p=s.querySelector("#type"),m=s.querySelector("#timein"),v=s.querySelector("#timeout"),y=s.querySelector(".ad-form__reset"),f=document.querySelector(".ad-form__submit");let w;const h=document.querySelector("#success").content.querySelector(".success"),_=document.querySelector("#error").content.querySelector(".error");c.addEventListener("input",(()=>{c.setCustomValidity(""),+l.value===o[0]&&+c.value!==n[2]&&c.setCustomValidity("Необходимо выбрать 1-го гостя"),+l.value===o[1]&&+c.value!==n[2]&&+c.value!==n[1]&&c.setCustomValidity("Необходимо выбрать 1-го или 2-х гостей"),+l.value===o[2]&&+c.value!==n[0]&&+c.value!==n[1]&&+c.value!==n[2]&&c.setCustomValidity("Необходимо выбрать 1-го, 2-х или 3-х гостей"),+l.value===o[3]&&+c.value!==n[3]&&c.setCustomValidity('Необходимо выбрать "не для гостей"'),c.reportValidity()})),d.addEventListener("input",(()=>{d.setCustomValidity(""),d.value.length<30&&d.setCustomValidity(`Заголовок объявления должен быть больше 30 символов. Сейчас ${d.value.length}.`),d.value.length>100&&d.setCustomValidity(`Заголовок объявления должен быть не более 100 символов. Сейчас ${d.value.length}.`),d.reportValidity()})),w=t[p.value],u.placeholder=""+w,u.min=w,p.addEventListener("change",(()=>{u.setAttribute("max",r),w=t[p.value],u.value="",u.placeholder=""+w,u.min=w,p.reportValidity()})),u.addEventListener("input",(()=>{const t=e[p.value];u.setCustomValidity(""),u.value>r&&u.setCustomValidity("Максимальная цена за ночь 1000000 руб."),u.value<w&&u.setCustomValidity(`Минимальная цена за ночь в типе жилья: ${t}, ${w} руб.`),u.reportValidity()})),m.addEventListener("change",(e=>{v.value=e.target.value})),v.addEventListener("change",(e=>{m.value=e.target.value}));const S=()=>{i.appendChild((()=>{const e=h.cloneNode(!0),t=n=>{n.key===a&&e.remove(),document.removeEventListener("keydown",t),document.removeEventListener("click",o)},o=()=>{e.remove(),document.removeEventListener("click",o),document.removeEventListener("keydown",t)};return document.addEventListener("keydown",t),document.addEventListener("click",o),e})()),s.reset(),window.map.setDisactiveState()},q=()=>{i.appendChild((()=>{const e=_.cloneNode(!0),t=e.querySelector(".error__button"),o=t=>{t.key===a&&e.remove(),document.removeEventListener("keydown",o),document.removeEventListener("click",n)},n=()=>{e.remove(),document.removeEventListener("click",n),document.removeEventListener("keydown",o)};return t.addEventListener("click",n),document.addEventListener("click",n),document.addEventListener("keydown",o),e})())};f.addEventListener("click",(()=>{E()}));const E=()=>{0===d.value.length&&d.setCustomValidity("Введите заголовок");const t=e[p.value];u.setCustomValidity(""),0===u.value.length&&u.setCustomValidity("Введите цену"),u.value>r&&u.setCustomValidity("Максимальная цена за ночь 1000000 руб."),u.value<w&&u.setCustomValidity(`Минимальная цена за ночь в типе жилья: ${t}, ${w} руб.`),c.setCustomValidity(""),100==+l.value&&0!=+c.value&&c.setCustomValidity("Выбранно неверное количество гостей "),+l.value<+c.value&&c.setCustomValidity("Выбранное количество гостей не поместятся в данное количество комнат")};s.addEventListener("submit",(e=>{window.backend.upload(new FormData(s),S,q),e.preventDefault(),window.map.setDefaultPinPosition()})),y.addEventListener("click",(()=>{s.reset(),window.map.setDisactiveState(),window.map.setDefaultPinPosition()}))})(),(()=>{const e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form__field input[type=file]"),o=document.querySelector(".ad-form__upload input[type=file]"),n=document.querySelector(".ad-form-header__preview img"),r=document.querySelector(".ad-form__photo"),a=(t,o)=>{const n=t.files[0];if(e.some((function(e){return n.type.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){o.src=e.result})),e.readAsDataURL(n)}};t.addEventListener("change",(()=>{a(t,n)})),o.addEventListener("change",(()=>{r.innerHTML='<img alt="Фото объекта" width="70" height="70">';const e=r.querySelector("img");a(o,e)}))})(),window.map.setDisactiveState()})();